<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<!--
Copyright 2019 J. Aaron Pendergrass

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->

<html> <head>
<style>
.node {
  cursor: pointer;
  stroke-width: 3px;
}

.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

div.tooltip {
    position: absolute;			
    text-align: center;			
    padding: 4px;
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;
}

div.about {
    position: absolute;
    display: inline-block;
    left: 40%;
    width: 20%;
    padding: 20px;
    top: 30%;
    background: lightsteelblue;
    border-radius: 12px;
    z-index: 10;
    pointer-events: auto;
}

div.about-close {
    position: absolute;
   display:inline-block;
    width:100%;
}

div.search-bar {
   z-index: 5;
}

.svg-container {
    display: inline-block;
    position: fixed;
    left: 0px;
    right: 0;
    top: 30px;
    bottom: 0;
    vertical-align: top;
}

.svg-content {
  display: inline-block;
  position: absolute;
  top: 0;
  left: 0;
}

</style>
<title>Taxonomy Browser</title>
  </head>

  <body>
    <div class="search-bar">
      <input id="search-input">
      <button id="search-button" onclick="do_search()">Search</button>
    </div>

    <div id="svg-container" class="svg-container"></div>
    
    <div id="about-div" class="about">
      <h1>Taxonomy Browser</h1>
      <p>A simple web application using D3 to browse the taxonomy
        database provided
        by <a href="https://www.itis.gov">ITIS</a>.
      </p>
      <p>Source code published under the BSD 3-Clause license
        available
        from <a href="https://github.com/jaaron/taxonomy-browser">https://github.com/jaaron/taxonomy-browser</a>	  
      </p>
      <h2>Usage</h2>
      <ul>
	<li>Hover over a node to show common and scientific names</li>
	<li>Click a node to expand/collapse its children</li>
	<li>Shift-Click a node to expand/collapse its ancestors</li>
	<li>Use the search bar to search by common name</li>
	<li>Lock a node in place by dragging it to a location</li>
	<li>Alt-Click a locked node to unlock it
	<li>Look up a node on Wikipedia or Google Image Search by
	  dragging it to the appropriate drop zone</li>
	<li>Hide a node by dragging it to the appropriate drop-zone</li>
      </ul>
      
      <p align="right">&copy; J. Aaron Pendergrass 2019</p>
      <div id="about-close-div" class="about-close">
	<a onclick="closeAbout()">close</a>
      </div>

    </div>
    
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>

function closeAbout(){
    d3.select("#about-div")
	.transition()
	.duration(500)
	.style("pointer-events", "none")
	.style("opacity", 0)
	.on("end", function(){
	    d3.select("#about-div")
		.style("display", "none")
	})
}

const states = {unloaded:  0,
		loading:   1,
		expanded:  2,
		collapsed: 3};

function def_node(obj){
    tmp = all_nodes[obj.tsn];
    if(tmp){
	tmp.visible = true;
	return tmp;
    }
    all_nodes[obj.tsn]     = obj;
    obj.id                 = obj.tsn;
    obj.visible            = true;
    obj.children_state     = states.unloaded;
    obj.ancestors_state    = states.unloaded;
    obj.children           = [];
    obj.parent             = null;
    return obj;
}

function setup_itis(){
    const cors_anywhere			= 'https://cors-anywhere.herokuapp.com/'
    const base_url			= cors_anywhere+'https://www.itis.gov/ITISWebService/jsonservice/'
    const search_by_cn_url		= base_url + 'searchByCommonName'
    const get_record_by_tsn_url		= base_url + 'getFullRecordFromTSN'
    const get_children_by_tsn_url	= base_url + 'getHierarchyDownFromTSN'
    const get_full_hierarchy_by_tsn_url = base_url + 'getFullHierarchyFromTSN'

    function search_for_name(cn){
	return fetch(search_by_cn_url+"?srchKey="+cn)
	    .then(r    => r.json())
	    .then(js   => js.commonNames)
	    .then(cns  => cns.map(cn => cn.tsn))
	    .then(tsns => tsns.map(get_record_by_tsn))
	    .then(ps   => Promise.all(ps))
    }

    function get_record_by_tsn(tsn){
	return fetch(get_record_by_tsn_url +"?tsn="+tsn)
	    .then(r => r.json())
    }

    function get_parent(rec){
	return get_record_by_tsn(rec.parentTSN.parentTsn)
    }

    function get_lineage(rec){
	return fetch(get_full_hierarchy_by_tsn_url+'?tsn='+rec.tsn)
	    .then(r => r.json())    
	    .then(js => js.hierarchyList)
	    .then(function(h){
		var recurse = function(i, acc){
		    if(i >= h.length){
			return acc;
		    }else if(h[i].tsn == rec.tsn){
			return acc
		    }else{
			return recurse(i+1, [h[i].tsn, ...acc])
		    }
		}
		return recurse(0, [])
	    })
	    .then(parent_tsns => parent_tsns.map(get_record_by_tsn))
	    .then(ps => Promise.all(ps))
    }

    function get_children(rec){
	return fetch(get_children_by_tsn_url+'?tsn='+rec.tsn)
	    .then(r => r.json())
	    .then(j => Promise.all(j.hierarchyList.filter(c => c)
				   .map(child => get_record_by_tsn(child.tsn))))
    }
    
    const animalia_tsn = 202423;
    function get_root(){return get_record_by_tsn(animalia_tsn);}
    
    return {
	search_for_name:   search_for_name,
	get_record_by_tsn: get_record_by_tsn,
	get_parent:        get_parent,
	get_lineage:       get_lineage,
	get_children:      get_children,
	get_root:          get_root
    }
}

const itis = setup_itis();

itis.get_root().then(function(p){
    p = def_node(p)
    update();
})

function do_search(){
    var search_input = document.getElementById("search-input")
    console.log("searching for "+search_input.value);
    loading_spinner.start_loading();
    itis.search_for_name(search_input.value)
	.then(function(xs){
	    if(xs){
		xs.forEach(def_node);
		update();
	    }
	}).catch(e => null)
	.finally(function(){loading_spinner.done_loading()});
};

/* Begin layout stuff */
var svg_container = d3.select("#svg-container")

var width = document.getElementById("svg-container").clientWidth,
    height = document.getElementById("svg-container").clientHeight,
    all_nodes = {};

var svg = svg_container
    .append("svg")
    .attr("viewBox", "0 0 "+width+" "+height)
    .classed("svg-content", true);

var nodes = []
var links = []
var simulation = d3.forceSimulation(nodes)
    .force("charge", d3.forceManyBody().strength(-1000))
    .force("link", d3.forceLink(link).distance(200))
    .force("x", d3.forceX())
    .force("y", d3.forceY())
    .alphaTarget(1)
    .on("tick", ticked);

var container = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
var link      = container.selectAll(".link");
var node      = container.selectAll(".node");

var zoom = d3.zoom()
    .scaleExtent([.1, 4])
    .on("zoom", function() { container.attr("transform", d3.event.transform); })
svg.call(zoom);

const max_node_radius = 50;
const min_node_radius = 10;

function update() {
    nodes = Object.values(all_nodes).filter(n => n.visible)
    links = nodes.reduce(function(acc, n){
	if(n.children){
	    return acc.concat(n.children
			      .filter(c => c.visible)
			      .map(function(c){
				  return {source: n,
					  target: c}
			      }))
	}else{
	    return acc;
	}
    }, [])


    // Update the nodes…
    console.log("laying out "+nodes.length+" nodes")
    node = node.data(nodes, n => n.id)

    // Exit any old nodes.
    node.exit().remove();

    node.transition().style("stroke", stroke)
    
    // Enter any new nodes.
    node = node.enter().append("circle")
	.attr("class", "node")
	.style("fill", color)
	.style("stroke", stroke)
	.attr("cx", d => d.x)
	.attr("cy", d => d.y)
	.attr("r", d => 30) /* Math.min(Math.max(min_node_radius, 30),
				 max_node_radius)) */
	.on("click", click)
	.on("mouseenter", show_hover_div)
	.on("mouseout", hide_hover_div)
	.on("contextmenu", function(d){console.log("hello");})
	.call(d3.drag()
	      .on("start", dragstarted)
	      .on("drag",  dragged)
	      .on("end",   dragended))
	.merge(node);

    // Update the links…
    link = link.data(links, d => d.target.id);
    
    // Exit any old links.
    link.exit().remove();

    // Enter any new links.
    link = link.enter().insert("line", ".node")
	.attr("class", "link")
	.attr("x1", function(d) { return d.source.x; })
	.attr("y1", function(d) { return d.source.y; })
	.attr("x2", function(d) { return d.target.x; })
	.attr("y2", function(d) { return d.target.y; })
    	.merge(link);
        
    // Restart the force layout.
    simulation.nodes(nodes)
    simulation.force("link").links(links);
    simulation.alpha(1).restart()
}

function ticked() {
    node.attr("cx", d => d.x);
    node.attr("cy", d => d.y);

    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });
}

function stroke(d) {
    if(d.fx || d.fy){
	return "black";
    }else{
	return "white";
    }
}

// Color leaf nodes orange, and packages white or blue.
function color(d) {
    if(d.taxRank.rankName.startsWith('Species')){
	return "#808080"
    }else if(d.children_state == states.expanded){
	return "#c6dbef"
    }
    return "#6ce0a4";
}

function add_child(parent, child){
    if(parent.children && !parent.children.includes(child)){
	parent.children = parent.children.concat(child);
	child.parent    = parent;
    }
}

function toggle_ancestors(d){
    function collapse_ancestors(d){
	function recurse(p){
	    if(p){
		p.visible = false;
		recurse(p.parent);
	    }
	}
	recurse(d.parent);
	d.ancestors_state = states.collapsed;
    }

    function expand_ancestors(d){
	function recurse(p){
	    if(p){
		p.visible = true;
		if(p.ancestors_state != states.collapsed){
		    recurse(p.parent);
		}
	    }
	}
	recurse(d.parent);
	d.ancestors_state = states.expanded;
    }

    function load_ancestors(d){
	loading_spinner.start_loading();
	d.ancestors_state = states.loading
	itis.get_lineage(d).then(function(ancestors){
	    self = d
	    ancestors.forEach(function(parent){
		parent = def_node(parent);
		add_child(parent, self);
		self = parent;
	    });
	    ancestors.forEach(function(p){
		p.ancestors_state = states.expanded;
	    });
	    d.ancestors_state = states.expanded;
	    update();
	}).finally(function(){loading_spinner.done_loading()});
    }
    
    if(d.ancestors_state == states.unloaded){
	load_ancestors(d);
    }else if(d.ancestors_state == states.expanded){
	collapse_ancestors(d);
    }else if(d.ancestors_state == states.collapsed){
	expand_ancestors(d);
    }
}

function toggle_children(d){
    function load_children(d){
	loading_spinner.start_loading();
	d.children_state = states.loading;
	itis.get_children(d).then(function(cs){
	    cs.forEach(function(c){
		c = def_node(c);
		add_child(d, c)
	    });
	    d.children_state = states.expanded;
	    update();
	}).finally(function(){loading_spinner.done_loading()});
    }
    function expand_children(d){
	d.children_state = states.expanded;
	var recurse = function(c){
	    c.visible = true;
	    if(!c.children_state == states.collapsed){
		c.children.forEach(recurse);
	    }
	}
	d.children.forEach(recurse);
    }
    function collapse_children(d){
	var recurse = function(c){
	    c.visible = false;	    
	    c.children.forEach(recurse);
	}
	d.children.forEach(recurse);
	d.children_state = states.collapsed;
	update();
    }

    if(d.children_state == states.unloaded){
	load_children(d)
    } else if (d.children_state == states.collapsed) {
	expand_children(d)
    } else if (d.children_state == states.expanded){
	collapse_children(d)
    }
}

    // Toggle children on click.
function click(d) {
    if (d3.event.defaultPrevented) {
	return;
    }
    if(d3.event.altKey) {
	d.fx = null;
	d.fy = null
    } else if (d3.event.shiftKey) {
	toggle_ancestors(d)
    } else {
	toggle_children(d)
    }
    update();
}

// tooltip
var hover_div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);

function show_hover_div(d){
    var text;
    var eng_name = d.commonNameList.commonNames.find(x => x && x.language == "English");
    if(eng_name){
	text = eng_name.commonName +
	    '<br/>('+d.scientificName.combinedName+')';
    }else{
	text = d.scientificName.combinedName;
    }
    hover_div
	.html(text)
	.style("left", (d3.event.pageX) + "px")
	.style("top", (d3.event.pageY-28)+"px");
    hover_div
	.transition()
	.duration(200)
	.style("opacity", .9);
}

function hide_hover_div(d){
    hover_div.transition()
	.duration(500)
	.style("opacity", 0)
}

// dragging
function dragstarted(d) {
    d3.event.sourceEvent.stopPropagation();
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.x = d.x;
    d.y = d.y;
    dropzones.show()   
}

function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
}

function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    dz = dropzones.selected();
    if(dz){
	console.log("in drop zone");
	dz.action(d);
	d.fx = null;
	d.fy = null;
    }else if(d3.event.dx * d3.event.dx + d3.event.dy * d3.event.dy > 9){
	d.fx = d3.event.x;
	d.fy = d3.event.y;
    }
    dropzones.hide();
    update();
}

function setup_dropzones(){
    // drop zone handling
    var dropzones = [{idx: 0, id:"wikipedia", title:"Wikipedia",
		      action: function(d){window.open("https://en.wikipedia.org/wiki/Special:Search?search="+
						      d.scientificName.combinedName)
					 }},
		     {idx: 1, id:"google-image", title:"Google Image Search",
		      action: function(d){window.open("https://www.google.com/search?tbm=isch&q="+
						      d.scientificName.combinedName)}},
		     {idx: 2, id:"hide", title:"Hide", action: function(d){d.visible = false}}]
    
    var dropzones_container = svg.append("g").attr("id", "dropzones");
    var dropzones_binding = dropzones_container.selectAll(".dropzone")
	.data(dropzones)
	.enter()
	.append("rect")
	.attr("class", "dropzone")
	.attr("opacity", 0.5)
	.attr("stroke-width", 2)
	.attr("stroke", "black")
	.attr("text", d => d.title)
	.attr("pointer-events", "visible")
	.on("mouseenter", select_dropzone)
	.on("mouseout", deselect_dropzone);
    
    var dropzones_labels = dropzones_container.selectAll(".dropzone_label")
	.data(dropzones)
	.enter()
	.append("text")
	.attr("font-family", "sans-serif")
	.attr("font-size", "20px")
	.attr("fill", "black")
	.attr("pointer-events", "none")
	.attr("text-anchor", "middle")
	.text(d => d.title)

    update_dropzones()

    function show_dropzones(){
	update_dropzones(1)
    }

    function hide_dropzones(){
	update_dropzones(-1)
    }

    function selected_dropzone(){
	return dropzones.find(d => d.selected);
    }


    function update_dropzones(active){
	dropzones_binding
	    .attr("fill", d => d.selected ? "yellow" : "grey")
            .attr("x", 0)
	    .attr("y", d => d.idx*height/dropzones.length)
	    .attr("width", width/4)
	    .attr("height", height/dropzones.length)

	dropzones_labels
	    .attr("fill", d => d.selected ? "black" : "white")
            .attr("x", width/8)
	    .attr("y", d => d.idx*height/dropzones.length + (height/(2*dropzones.length)))

	if(active != 0){
	    dropzones_binding.attr("visibility", active > 0 ? "visible" : "hidden")
	    dropzones_labels.attr("visibility", active > 0? "visible" : "hidden")
	}	
    }

    function select_dropzone(dz){
	console.log("selecting dropzone "+dz.id)
	dropzones.forEach(function(d){d.selected = (d == dz);})
	update_dropzones(0)
    }

    function deselect_dropzone(dz){
	console.log("deselecting dropzone")
	dz.selected = false;
	update_dropzones(0);
    }

    return{ update: update_dropzones,
	    select: select_dropzone,
	    deselect: deselect_dropzone,
	    show: show_dropzones,
	    hide: hide_dropzones,
	    selected: selected_dropzone
	  }
}

function spinner(){    
    var radius = 50 / 2;
    var tau = 2 * Math.PI;
    
    var arc = d3.arc()
	.innerRadius(radius*0.5)
	.outerRadius(radius*0.9)
	.startAngle(0)
	.endAngle(0.33*tau)

    var container = svg.append("g")
    	.attr("id", "spinner-container")
	.attr("transform", "translate(" + (width - 2*radius) + ","+ (height - 2*radius)+")")

    var path = container
	.append("path")
	.attr("d", arc)
	.attr("fill", "#4D4D4D")
	.attr("visibility", "hidden")
	.call(spin, 1500);
    
    function spin(selection, duration) {
	selection.transition()
            .ease(d3.easeLinear)
            .duration(duration)
            .attrTween("transform", function() {
		return d3.interpolateString("rotate(0)", "rotate(360)");
            });
	
	setTimeout(function() { spin(selection, duration); }, duration);
    }

    var load_count = 0;
    return {
	start_loading: function(){
	    load_count += 1;
	    path.attr("visibility", "visible")
	},
	done_loading: function(){
	    load_count -= 1;
	    if(load_count <= 0){
		path.attr("visibility", "hidden");
	    }
	},
	relocate: function(){
	    container.attr("transform",
			   "translate(" + (width - 2*radius) + ","+ (height - 2*radius)+")")
	}
    }
}

const loading_spinner = spinner();
const dropzones       = setup_dropzones();

function redraw_all(){
    width = document.getElementById("svg-container").clientWidth,
    height = document.getElementById("svg-container").clientHeight,

    svg.attr("width", width)
    svg.attr("height", height)
    svg.attr("viewBox", "0 0 "+width+" "+height)
    dropzones.update();
    loading_spinner.relocate();
    update();
}

window.addEventListener("resize", redraw_all)

    

</script>
